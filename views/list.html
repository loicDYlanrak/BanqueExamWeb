<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Liste des prêts</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
        }

        button {
            padding: 5px 10px;
            cursor: pointer;
        }

        select {
            margin-right: 10px;
        }
    </style>
</head>

<body>

    <h1>Liste des prêts</h1>

    <div>
        <label>Filtrer :</label>
        <select id="filtre_actif">
            <option value="">Tous</option>
            <option value="1">Actifs</option>
            <option value="0">Clôturés</option>
        </select>

        <select id="filtre_retard">
            <option value="">Tous</option>
            <option value="1">En retard</option>
        </select>

        <button onclick="chargerPrets()">Actualiser</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Client</th>
                <th>Type de prêt</th>
                <th>Montant</th>
                <th>Date début</th>
                <th>Est actif</th>
                <th>Total remboursé</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tbody-prets"></tbody>
    </table>

    <script>
        const apiBase = "http://localhost:8000";

        function ajax(method, url, data, callback, errorCallback) {
            const xhr = new XMLHttpRequest();
            xhr.open(method, apiBase + url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        callback(JSON.parse(xhr.responseText));
                    } else {
                        if (errorCallback) errorCallback(xhr);
                    }
                }
            };
            xhr.send(data ? JSON.stringify(data) : null);
        }

        function chargerPrets() {
            const actif = document.getElementById("filtre_actif").value;
            const retard = document.getElementById("filtre_retard").value;

            let url = "/prets?";
            if (actif !== "") url += "est_actif=" + actif + "&";
            if (retard === "1") url += "en_retard=1&";

            ajax("GET", url, null, afficherPrets, () => {
                alert("Erreur lors du chargement des prêts.");
            });
        }

        function afficherPrets(prets) {
            const tbody = document.getElementById("tbody-prets");
            tbody.innerHTML = "";

            prets.forEach(p => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.nom} ${p.prenom}</td>
          <td>${p.type_nom} (${p.taux}%)</td>
          <td>${p.montant}</td>
          <td>${new Date(p.date_debut).toLocaleDateString()}</td>
          <td>${p.est_actif ? "Oui" : "Non"}</td>
          <td>${p.total_rembourse}</td>
          <td>
            ${p.est_actif ? `<button onclick="rembourser(${p.id})">Rembourser</button>` : ""}
          </td>
        `;
                tbody.appendChild(tr);
            });
        }

        function rembourser(pretId) {
            const montant = prompt("Montant du remboursement :");
            const montantFloat = parseFloat(montant);
            if (isNaN(montantFloat) || montantFloat <= 0) {
                alert("Montant invalide.");
                return;
            }
            const data = `pret_id=${pretId}&montant=${montantFloat}`;
            ajax("POST", "/rembourser", data, () => {
                alert("Remboursement enregistré !");
                chargerPrets();
            }, () => {
                alert("Erreur lors du remboursement.");
            });
        }

        // Chargement initial
        chargerPrets();
    </script>

</body>

</html>
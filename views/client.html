<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Gestion des Clients</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .form-container {
      background-color: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    input,
    button {
      margin: 5px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #45a049;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #4CAF50;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    .client-details {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background-color: #f9f9f9;
    }

    .active {
      display: block;
    }
  </style>
</head>

<body>

  <h1>Gestion des Clients</h1>

  <div class="form-container">
    <h2>Rechercher un client</h2>
    <input type="text" id="search" placeholder="Nom, pr√©nom ou t√©l√©phone">
    <button onclick="rechercherClients()">Rechercher</button>

    <h2>Ajouter un nouveau client</h2>
    <input type="text" id="nom" placeholder="Nom">
    <input type="text" id="prenom" placeholder="Pr√©nom">
    <input type="text" id="telephone" placeholder="T√©l√©phone">
    <input type="email" id="email" placeholder="Email">
    <button onclick="ajouterClient()">Ajouter</button>
  </div>

  <table id="table-clients">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nom</th>
        <th>Pr√©nom</th>
        <th>T√©l√©phone</th>
        <th>Email</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="client-details" class="client-details">
    <h2>D√©tails du Client</h2>
    <div id="client-info"></div>

    <h3>Pr√™ts du Client</h3>
    <table id="table-prets">
      <thead>
        <tr>
          <th>ID</th>
          <th>Type</th>
          <th>Montant</th>
          <th>Date d√©but</th>
          <th>Dur√©e (mois)</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="fermerDetails()">Fermer</button>
  </div>

  <!-- Ajoutez ce div apr√®s le panneau de d√©tails client -->
  <div id="client-edit" class="client-details">
    <h2>Modifier le Client</h2>
    <input type="hidden" id="edit-id">
    <div>
      <label>Nom:</label>
      <input type="text" id="edit-nom">
    </div>
    <div>
      <label>Pr√©nom:</label>
      <input type="text" id="edit-prenom">
    </div>
    <div>
      <label>T√©l√©phone:</label>
      <input type="text" id="edit-telephone">
    </div>
    <div>
      <label>Email:</label>
      <input type="email" id="edit-email">
    </div>
    <button onclick="sauvegarderModification()">Enregistrer</button>
    <button onclick="annulerModification()">Annuler</button>
  </div>

  <script>
    const apiBase = "http://localhost:8000";

    // Fonction AJAX g√©n√©rique
    function ajax(method, url, data, callback, errorCallback) {
      const xhr = new XMLHttpRequest();
      xhr.open(method, apiBase + url, true);

      if (method === 'POST' || method === 'PUT') {
        xhr.setRequestHeader("Content-Type", "application/json");
      }

      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            callback(JSON.parse(xhr.responseText));
          } else if (errorCallback) {
            errorCallback(xhr);
          } else {
            console.error("Error:", xhr.status, xhr.responseText);
          }
        }
      };

      xhr.send(method === 'GET' ? null : JSON.stringify(data));
    }

    // Charger la liste des clients
    function chargerClients(search = '') {
      const url = search ? `/clients?search=${encodeURIComponent(search)}` : '/clients';

      ajax("GET", url, null, (data) => {
        const tbody = document.querySelector("#table-clients tbody");
        tbody.innerHTML = "";

        data.forEach(client => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${client.id}</td>
            <td>${client.nom}</td>
            <td>${client.prenom}</td>
            <td>${client.telephone || '-'}</td>
            <td>${client.email || '-'}</td>
            <td>
              <button onclick='afficherDetailsClient(${client.id})'>üëÅÔ∏è D√©tails</button>
              <button onclick='afficherFormulaireModification(${JSON.stringify(client)})'>‚úèÔ∏è Modifier</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      });
    }

    // Ajoutez ces nouvelles fonctions:
    function afficherFormulaireModification(client) {
      // Remplir le formulaire
      document.getElementById("edit-id").value = client.id;
      document.getElementById("edit-nom").value = client.nom;
      document.getElementById("edit-prenom").value = client.prenom;
      document.getElementById("edit-telephone").value = client.telephone || '';
      document.getElementById("edit-email").value = client.email || '';

      // Afficher le panneau de modification
      document.getElementById("client-edit").classList.add("active");
      document.getElementById("client-details").classList.remove("active");
    }

    function annulerModification() {
      document.getElementById("client-edit").classList.remove("active");
    }

    function sauvegarderModification() {
      const id = document.getElementById("edit-id").value;
      const nom = document.getElementById("edit-nom").value;
      const prenom = document.getElementById("edit-prenom").value;
      const telephone = document.getElementById("edit-telephone").value;
      const email = document.getElementById("edit-email").value;

      if (!nom) {
        alert("Le nom est obligatoire");
        return;
      }

      ajax("PUT", `/clients/${id}`, {
        nom, prenom, telephone, email
      }, () => {
        // Fermer le panneau de modification
        document.getElementById("client-edit").classList.remove("active");

        // Recharger la liste des clients
        chargerClients();

        alert("Client modifi√© avec succ√®s");
      }, (error) => {
        alert("Erreur lors de la modification du client");
        console.error(error);
      });
    }

    // Afficher les d√©tails d'un client
    function afficherDetailsClient(id) {
      ajax("GET", `/clients/${id}`, null, (client) => {
        // Afficher les infos du client
        document.getElementById("client-info").innerHTML = `
          <p><strong>Nom:</strong> ${client.nom} ${client.prenom}</p>
          <p><strong>T√©l√©phone:</strong> ${client.telephone || '-'}</p>
          <p><strong>Email:</strong> ${client.email || '-'}</p>
        `;

        // Afficher ses pr√™ts
        const tbody = document.querySelector("#table-prets tbody");
        tbody.innerHTML = "";

        client.prets.forEach(pret => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${pret.id}</td>
            <td>${pret.type_pret}</td>
            <td>${pret.montant} ‚Ç¨</td>
            <td>${pret.date_debut}</td>
            <td>${pret.duree_mois}</td>
            <td>${pret.est_actif ? 'Actif' : 'Cl√¥tur√©'}</td>
          `;
          tbody.appendChild(tr);
        });

        // Afficher le panneau de d√©tails
        document.getElementById("client-details").classList.add("active");
      });
    }

    // Fermer les d√©tails du client
    function fermerDetails() {
      document.getElementById("client-details").classList.remove("active");
    }

    // Rechercher des clients
    function rechercherClients() {
      const search = document.getElementById("search").value;
      chargerClients(search);
    }

    // Ajouter un nouveau client
    function ajouterClient() {
      const nom = document.getElementById("nom").value;
      const prenom = document.getElementById("prenom").value;
      const telephone = document.getElementById("telephone").value;
      const email = document.getElementById("email").value;

      if (!nom) {
        alert("Le nom est obligatoire");
        return;
      }

      ajax("POST", "/clients", {
        nom, prenom, telephone, email
      }, () => {
        // R√©initialiser le formulaire
        document.getElementById("nom").value = "";
        document.getElementById("prenom").value = "";
        document.getElementById("telephone").value = "";
        document.getElementById("email").value = "";

        // Recharger la liste
        chargerClients();
      }, (error) => {
        alert("Erreur lors de l'ajout du client");
        console.error(error);
      });
    }

    // Charger les clients au d√©marrage
    chargerClients();
  </script>

</body>

</html>
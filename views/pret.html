<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion des Prêts</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #message { margin-top: 15px; }
    .section { margin-bottom: 40px; }
  </style>
</head>
<body>

<div class="section">
  <h1>Créer un Prêt</h1>
  <div class="mb-3">
    <select id="client_id" class="form-select d-inline-block w-auto"></select>
    <select id="type_pret_id" class="form-select d-inline-block w-auto"></select>
    <input type="number" id="montant" placeholder="Montant" class="form-control d-inline-block w-auto" />
    <input type="date" id="date_debut" class="form-control d-inline-block w-auto" />
    <button onclick="creerPret()" class="btn btn-primary">Valider le prêt</button>
    <div id="mensualite_preview" class="mt-2"></div>
  </div>
  <div id="message"></div>
</div>

<div class="section">
  <h1>Liste des prêts</h1>
  <div class="mb-3">
    <label>Filtrer :</label>
    <select id="filtre_actif" class="form-select d-inline-block w-auto">
      <option value="">Tous</option>
      <option value="1">Actifs</option>
      <option value="0">Clôturés</option>
    </select>
    <select id="filtre_retard" class="form-select d-inline-block w-auto">
      <option value="">Tous</option>
      <option value="1">En retard</option>
    </select>
    <button onclick="chargerPrets()" class="btn btn-secondary">Actualiser</button>
  </div>

  <table class="table table-bordered">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Client</th>
        <th>Type de prêt</th>
        <th>Montant</th>
        <th>Date début</th>
        <th>Est actif</th>
        <th>Total remboursé</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tbody-prets"></tbody>
  </table>
</div>

<!-- Modal Bootstrap pour l’annuité annuelle -->
<div class="modal fade" id="modalEcheancier" tabindex="-1" aria-labelledby="echeancierLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="echeancierLabel">Échéancier Annuel du Prêt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <table class="table table-striped table-bordered">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Année</th>
              <th>Capital</th>
              <th>Intérêt</th>
              <th>Assurance</th>
              <th>Annuité</th>
              <th>Reste à payer</th>
            </tr>
          </thead>
          <tbody id="tbody-echeancier"></tbody>
        </table>
        <div class="text-end mt-3">
          <button id="btn-valider-pret" class="btn btn-success">✅ Valider définitivement le prêt</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const apiBase = "http://localhost:8000";
  let currentPretId = null;

  function ajax(method, url, data, callback, errorCallback) {
    const xhr = new XMLHttpRequest();
    xhr.open(method, apiBase + url, true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = () => {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          callback(JSON.parse(xhr.responseText));
        } else {
          if (errorCallback) errorCallback(xhr);
        }
      }
    };
    xhr.send(data);
  }

  function chargerClients() {
    ajax("GET", "/clients", null, (data) => {
      const select = document.getElementById("client_id");
      select.innerHTML = "";
      data.forEach(client => {
        const opt = document.createElement("option");
        opt.value = client.id;
        opt.textContent = `${client.nom} ${client.prenom}`;
        select.appendChild(opt);
      });
    });
  }

  function chargerTypesPret() {
    ajax("GET", "/type_pret", null, (data) => {
      const select = document.getElementById("type_pret_id");
      select.innerHTML = "";
      data.forEach(type => {
        const opt = document.createElement("option");
        opt.value = type.id;
        opt.textContent = `${type.nom} - ${type.taux}%`;
        select.appendChild(opt);
      });
    });
  }

  function creerPret() {
    const client_id = document.getElementById("client_id").value;
    const type_pret_id = document.getElementById("type_pret_id").value;
    const montant = parseFloat(document.getElementById("montant").value);
    const date_debut = document.getElementById("date_debut").value;

    if (!client_id || !type_pret_id || isNaN(montant)) {
      afficherMessage("Veuillez remplir tous les champs.", true);
      return;
    }

    const data = `client_id=${client_id}&type_pret_id=${type_pret_id}&montant=${montant}&date_debut=${date_debut}`;

    ajax("POST", "/prets", data, (res) => {
      afficherMessage(`✅ Prêt créé !<br>ID: ${res.id}<br>Mensualité: ${res.mensualite}<br>Durée: ${res.duree_mois} mois`);
      document.getElementById("montant").value = "";
      chargerPrets();
    }, (xhr) => {
      try {
        const erreur = JSON.parse(xhr.responseText);
        afficherMessage("❌ Erreur : " + erreur.error, true);
      } catch (e) {
        afficherMessage("❌ Erreur inattendue", true);
      }
    });
  }

  function afficherMessage(msg, isError = false) {
    const div = document.getElementById("message");
    div.innerHTML = msg;
    div.style.color = isError ? "red" : "green";
  }

  function chargerPrets() {
    const actif = document.getElementById("filtre_actif").value;
    const retard = document.getElementById("filtre_retard").value;

    let url = "/prets?";
    if (actif !== "") url += "est_actif=" + actif + "&";
    if (retard === "1") url += "en_retard=1&";

    ajax("GET", url, null, afficherPrets, () => {
      alert("Erreur lors du chargement des prêts.");
    });
  }

  function voirEcheancier(pretId) {
    currentPretId = pretId;
    ajax("GET", `/prets/${pretId}/annuite`, null, (data) => {
      const tbody = document.getElementById("tbody-echeancier");
      tbody.innerHTML = "";

      data.forEach((ligne, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${ligne.periode}</td>
          <td>${ligne.annee}</td>
          <td>${ligne.pret}</td>
          <td>${ligne.interet}</td>
          <td>${ligne.assurance}</td>
          <td>${ligne.mensualite}</td>
          <td>${ligne.valeur_net}</td>
        `;
        tbody.appendChild(tr);
      });

      const modal = new bootstrap.Modal(document.getElementById("modalEcheancier"));
      modal.show();
    }, () => {
      alert("Erreur lors du chargement de l’échéancier annuel.");
    });
  }

  document.getElementById("btn-valider-pret").addEventListener("click", function () {
    if (!currentPretId) return;

    if (!confirm("Valider ce prêt et générer les mensualités ?")) return;

    ajax("POST", `/prets/${currentPretId}/valider`, "", (res) => {
      alert("✅ Prêt validé avec succès !");
      chargerPrets();
      const modal = bootstrap.Modal.getInstance(document.getElementById("modalEcheancier"));
      modal.hide();
    }, (xhr) => {
      alert("❌ Erreur : " + xhr.responseText);
    });
  });

  function rembourser(pretId) {
    const montant = prompt("Montant du remboursement :");
    const montantFloat = parseFloat(montant);
    if (isNaN(montantFloat) || montantFloat <= 0) {
      alert("Montant invalide.");
      return;
    }
    const data = `pret_id=${pretId}&montant=${montantFloat}`;
    ajax("POST", "/rembourser", data, () => {
      alert("Remboursement enregistré !");
      chargerPrets();
    }, () => {
      alert("Erreur lors du remboursement.");
    });
  }

  function afficherPrets(prets) {
    const tbody = document.getElementById("tbody-prets");
    tbody.innerHTML = "";

    prets.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.id}</td>
        <td>${p.nom} ${p.prenom}</td>
        <td>${p.type_nom} (${p.taux}%)</td>
        <td>${p.montant}</td>
        <td>${new Date(p.date_debut).toLocaleDateString()}</td>
        <td>${p.est_actif ? "Oui" : "Non"}</td>
        <td>${p.total_rembourse}</td>
        <td>
          ${p.est_actif ? `<button onclick="rembourser(${p.id})" class="btn btn-success btn-sm mb-1">Rembourser</button>` : ""}
          <button onclick="voirEcheancier(${p.id})" class="btn btn-info btn-sm">Échéancier</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Initialisation
  chargerClients();
  chargerTypesPret();
  chargerPrets();
</script>

</body>
</html>
